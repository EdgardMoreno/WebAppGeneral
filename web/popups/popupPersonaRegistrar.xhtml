<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:p="http://primefaces.org/ui" >

    <f:metadata>
        <f:viewParam name="paramExternalPage" value="#{personController.paramPageFlgActivo}"/>
        <f:viewParam name="paramCodIden" value="#{personController.sic1idenpersId.codIden}"/>        
    </f:metadata>

    <h:head>
        <title>Registrar Persona</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta charset="utf-8"/>

        <!--CSS STYLE -->
        <h:outputStylesheet name="/datepicker/css/datepicker.css"/><!--DatePicker -->
        <h:outputStylesheet name="/css/bootstrap.min.css"/>
        <h:outputStylesheet name="/css/customizer.css"/>
        <h:outputStylesheet name="/css/jquery-confirm-3.3.css"/>        

        <!--JQUERY-->
        <script src="#{request.contextPath}/faces/resources/js/jquery-3.2.1.min.js"></script>
        <script src="#{request.contextPath}/faces/resources/js/customizerJS.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js" />

        <script src="#{request.contextPath}/faces/resources/datepicker/js/bootstrap-datepicker.js"></script>
        <script src="#{request.contextPath}/faces/resources/datepicker/js/formatDatePicker.js"></script>

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="#{request.contextPath}/faces/resources/js/jquery-confirm-3.3.js"></script>


        <script>

            $(document).ready(function () {

                //Por defecto se oculta los campos de Razon Social
                var obj = document.getElementById("form:pgFields");
                obj.rows[1].style.display = "none";

                //Setear por defecto Genero MASCULINO
                document.forms['form']['form:sorGenero'][0].checked = true;

                //INVOCACION PAGINA EXTERNA: se bloquea el campo del DNI/RUC
                var flgParam = $("#form\\:idFlgPaginaExterna").val();
                if (Number(flgParam) == 1) {
                    $("#form\\:numDocuIden").attr("disabled", "true");
                }

            });

            function fnChangeTab(option) {

                if (option == 1) {
                    $('[href="#menu1"]').tab('show');
                } else if (option == 2) {
                    $('[href="#menu2"]').tab('show');
                }

                return false;

            }
            ;

            function fnOcultarTipoPers(valor) {

                var resultado = fnGetPersType(String(valor));
                var arrMensajes = [];

                var obj = document.getElementById("form:pgFields");

                if (resultado == "PJ") {
                    /*Mostrar Fila Persona Juridica*/
                    obj.rows[1].style.display = "";

                    /*Oculatar Filas Persona Natural*/
                    obj.rows[2].style.display = "none";
                    obj.rows[3].style.display = "none";
                    obj.rows[4].style.display = "none";
                    obj.rows[5].style.display = "none";

                } else {
                    /*Mostrar Filas Persona Natural*/
                    obj.rows[2].style.display = "";
                    obj.rows[3].style.display = "";
                    obj.rows[4].style.display = "";
                    obj.rows[5].style.display = "";

                    /*Ocultar Filas Persona Juridica*/
                    obj.rows[1].style.display = "none";
                }

                if (resultado == "ERROR") {
                    arrMensajes.push("El formato del Documento de Identidad es inválido.");
                    fnShowMessageValidation(arrMensajes);
                } else {
                    fnHideMessageValidation();
                }
            }
            ;

            function fnValidateForm() {

                //obteniendo el valor que se puso en campo text del formulario
                var docuIden = document.getElementById("form:numDocuIden").value;
                var primerNombre = document.getElementById("form:primerNombre").value;
                var apeMaterno = document.getElementById("form:apeMaterno").value;
                var apePaterno = document.getElementById("form:apePaterno").value;
                var razonSocial = document.getElementById("form:razonSocial").value;
                var flgError = false;
                var mensaje;
                var arrMessages = [];
                var genero = -1;

                /*if (document.forms['form']['form:cboTipoPersona'][0].checked == true) {
                 valorTipoPersona = document.forms['form']['form:cboTipoPersona'][0].value;
                 } else if (document.forms['form']['form:cboTipoPersona'][1].checked == true) {
                 valorTipoPersona = document.forms['form']['form:cboTipoPersona'][1].value;
                 }*/

                if (document.forms['form']['form:sorGenero'][0].checked == true) {
                    genero = document.forms['form']['form:sorGenero'][0].value;
                } else if (document.forms['form']['form:sorGenero'][1].checked == true) {
                    genero = document.forms['form']['form:sorGenero'][1].value;
                }


                if (docuIden.length == 0) {
                    arrMessages.push("Debe ingresar el Documento de Identidad.");
                    flgError = true;
                } else {

                    mensaje = fnGetPersType(docuIden);

                    if (mensaje == "PJ") {
                        if (razonSocial.length == 0) {
                            arrMessages.push("Se debe ingresar la Razón Social.");
                            flgError = true;
                        }
                    } else if (mensaje == "PN") {

                        if (primerNombre.length == 0) {
                            arrMessages.push("Se debe ingresar el Primer Nombre");
                            flgError = true;
                        }

                        if (apePaterno.length == 0) {
                            arrMessages.push("Se debe ingresar el Apellido Paterno.");
                            flgError = true;
                        }

                        if (apeMaterno.length == 0) {
                            arrMessages.push("Se debe ingresar el Apellido Materno.");
                            flgError = true;
                        }

                        if (genero == -1) {
                            arrMessages.push("Se debe especificar el género.");
                            flgError = true;
                        }
                    }
                }

                //IMPRIMIR RESULTADO
                if (flgError == true) {
                    fnShowMessageValidation(arrMessages);
                    return false;
                } else {
                    fnHideMessageValidation();
                    fnShowDialogConfirm("form\\:btnGrabar"); // -> Se pasa como parametro el ID del boton que tiene el metodo actionListener
                    return false;
                }

            }
            ;

            /*Función que se ejecuta durante el ciclo de vida de la llamada AJAX.
             *Cierra el IFRAME*/
            function fnAjaxListenSavePerson(data) {

                var flgParam = $("#form\\:idFlgPaginaExterna").val();
                /*Pregunta si la pagina ha sido llamada desde una pagina externa*/
                if (Number(flgParam) == 1) {

                    switch (data.status) {
                        case "success":
                            var idPers = $("#form\\:idPersona").val();
                            //alert("idPers:" + Number(idPers));
                            if (Number(idPers) > 0) {
                                parent.$.fancybox.close();
                                parent.fnCloseIFrame_fromRegisterPerson();
                            }
                            break;
                    }
                }
            }


            

        </script>

    </h:head>
    <h:body>

        <div class="container">

            <div id="divResultadoValidacion"></div>

            <h:form id="form">

                <p:growl id="message" showDetail="true" />

                <div class="container">

                    <div class="page-header" >
                        <h3>Registrar Cliente</h3>
                    </div>

                    <br/>
                    <h:panelGrid id="pgFields" columns="4" 
                                 style="width:100%"
                                 columnClasses="td-label-1, text_panelGrid_4c , td-label-1 , text_panelGrid_4c">

                        <h:outputLabel value="Documento Identidad:"/>
                        <h:inputText id="numDocuIden"
                                     class="form-control"                                     
                                     style="width:70%"
                                     onchange="fnOcultarTipoPers(this.value)"
                                     onkeypress="return allowOnlyNumbers(event)"
                                     value="#{personController.sic1idenpersId.codIden}">
                        </h:inputText>
                        <h:outputLabel value="" />
                        <h:outputLabel value="" />

                        <h:outputLabel value="Razón Social:"/>
                        <h:inputText styleClass="form-control left" id="razonSocial" value="#{personController.sic1persorga.desPersorga}" />
                        <h:outputLabel value="" />
                        <h:outputLabel value="" />

                        <h:outputLabel value="Nombre:"/>
                        <h:inputText  styleClass="form-control" id="primerNombre" value="#{personController.sic1persindi.desPrimnomb }" />

                        <h:outputLabel value=""/>
                        <h:outputLabel value=""/>

                        <h:outputLabel value="Apellido Paterno:"/>
                        <h:inputText  styleClass="form-control" id="apePaterno" value="#{personController.sic1persindi.desApelpate}" />

                        <h:outputLabel value="Apellido Materno:"/>
                        <h:inputText  styleClass="form-control" id="apeMaterno" value="#{personController.sic1persindi.desApelmate}" />

                        <h:outputLabel value="Genero:"/>
                        <h:selectOneRadio id="sorGenero" value="#{personController.sic1persindi.idGenero}">
                            <f:selectItems value="#{personController.itemsGeneroPers}" />
                        </h:selectOneRadio>

                        <h:outputLabel value="Fecha Nacimiento:"/>
                        <h:inputText value="#{personController.desFecNaci}" styleClass="form-control datepicker" />

                        <h:outputLabel value="Distrito:"/>
                        <h:inputText styleClass="form-control" value="#{personController.sic1lugar.desLugar}" />                        

                        <h:outputLabel value="idPersona:" style="display: none"/>
                        <h:inputText id="idPersona" value="#{personController.sic1pers.idPers}" style="display: none"/>

                        <h:outputLabel value="flgPaginaExterna" style="display: none"/>
                        <h:inputText id="idFlgPaginaExterna" value="#{personController.paramPageFlgActivo}" style="display: none"/>

                    </h:panelGrid>
                    <br/>
                    <div class="offset-sm-2 col-sm-10">
                        <input type="button" id="btnConfirm" value="Grabar" class="btn btn-primary" onclick="return fnValidateForm()"/>
                        <input type="button" id="btnConfirm" value="Cancelar" class="btn btn-primary" onclick="parent.$.fancybox.close();"/>
                    </div>
                </div>

                <h:commandButton id="btnGrabar" style="display: none">
                    <f:ajax execute="form" render="message pgFields idPersona idFlgPaginaExterna" listener="#{personController.savePerson()}" onevent="fnAjaxListenSavePerson"/>
                </h:commandButton>

            </h:form>

        </div> 

    </h:body>
</html>
