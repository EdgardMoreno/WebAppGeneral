<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:a="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets" >

    
    <ui:composition template="./WEB-INF/facelets/templates/templatePrincipal.xhtml">

        <ui:define name="header">

            <style>
                
                textarea {
                    resize: none;
                }
                
                .autocomplete{
                    position: absolute;
                    background-color: white;
                    /*border: 1px solid black;*/
                    z-index: 10;/*Indica la posicion en el eje Z, en nuestro caso con el valor 10 
                                el elemento se muestra delante del resto de elementos, probablemente alguna 
                                clase tiene el valor z-index mayor a 0*/
                    padding: 0px;                    
                }

                .panelIngresoDatosOrden {
                    position:relative;
                    float:left;
                    /*border: 1px solid black;*/
                    width: 71%;
                }

                .panelResumenOrden {
                    position:relative;
                    float:right;
                    width: 28%;
                    border: 1px inset #FFF;
                    background-color: #167F92;
                }

                /*#idDivFinal{

                    position:relative;
                    float   :left;
                    border  : 1px solid black;
                    width   : 400px;
                    text-align: center;
                    display : none;
                    background-color: white;
                    padding: 10px;
                }*/


                .calcularVuelto{
                    border: 2px outset #FFF;
                    text-align: center;
                    height: 35px;
                    padding: 5px;
                    /*vertical-align: middle;*/                    
                }

                /*.calcularVuelto:hover{
                    background-color: #13004d;
                    font-size: 15px;
                    padding: 5px;
                }*/
                .calcularVuelto{
                    background-color: #13004d;
                    font-size: 15px;
                    padding: 5px;
                }

            </style>

            <script>               
              

                $(document).ready(function () {

                    //Se utiliza para llamar a URL externa
                    $(".iframe").fancybox({

                        type: "iframe",
                        modal: "true",
                        enableEscapeButton: "false",
                        autoDimensions: "false",
                        width: 800,
                        height: 460,
                        autoSize: false,
                        overlayColor: "#797379",
                        titleShow: true,
                        titlePosition: "outside",
                        overlayOpacity: 0.6,
                        transitionIn: "elastic",
                        transitionOut: "elastic"

                    });

                    //Se utiliza para llamar a DIV
                    $("#idLink").fancybox({
                        type: "inline",
                        modal: "true",
                        enableEscapeButton: "false",
                        autoDimensions: "false",
                        overlayColor: "#797379",
                        titleShow: true,
                        titlePosition: "outside",
                        overlayOpacity: 0.6,
                        transitionIn: "elastic",
                        transitionOut: "elastic"
                    });

                });
                

                /*Funcion que permite calcular el vuelto*/
                function fnCalcularVuelto() {

                    var mtoTarjeta = $("#form\\:numMtotarjeta").val();
                    var mtoEfectivo = $("#form\\:numMtoefectivo").val();
                    var mtoTotal = $("#form\\:numMtoTotal").text();

                    var totalFavor = (Number(mtoTarjeta == "" ? 0 : mtoTarjeta) +
                            Number(mtoEfectivo == "" ? 0 : mtoEfectivo));

                    var totalVuelto = totalFavor - Number(mtoTotal);
                    totalVuelto = totalVuelto > 0 ? totalVuelto : 0;
                    totalVuelto = fnFormatDecimal(String(totalVuelto));

                    //alert("mtoTotal: " + mtoTotal + " total:" + totalVuelto);

                    fnShowInfoMessage("Vuelto Calculado: S/." + totalVuelto);
                }

                /*Funcion que muestra la cantidad de digitos ingresados del DNI/RUC*/
                function fnCountDigitsCodIden(val) {
                    $("#idCantDigitosDocIden").text(val.value.length);
                    $("#form\\:razonSocial").val("");
                }

                /*Funcion que se utiliza para validar el formulario*/
                function fnValidateOrderForm() {


                    //var codSerie = document.getElementById("form:codSerie").value;
                    //var numDocumento = document.getElementById("form:numDocumento").value;
                    var fecRegistro = document.getElementById("form:fecRegistro").value;
                    //var idenDocum = document.getElementById("form:numDocuIden").value;
                    var razonSocial = document.getElementById("form:razonSocial").value;
                    //var detItems    = document.getElementById("form:idTableDetOrder").rows.length;
                    var numMtoTotal = $("#form\\:numMtoTotal").text();
                    
                    console.log("Elemento:" + document.getElementById("form:idPayMode"));
                    
                    var tipoProducto = document.getElementById("form:idPayMode");
                    var idTipoProducto = 99;
                    
                    if (tipoProducto != null)
                        idTipoProducto = tipoProducto.selectedIndex;

                    numMtoTotal = Number(numMtoTotal);

                    var FlgError = false;
                    var arrMessages = [];

                    if (fecRegistro.length == 0) {
                        arrMessages.push("Debe ingresar la fecha de la operación.");
                        FlgError = true;
                    }else if(!fnValidateDateDDMMAAAA(fecRegistro)){
                        arrMessages.push("El formato de la Fecha de Registro es incorrecto.");
                        FlgError = true;
                    }else{
                        /*Validar fecha mayor a la actual*/
                        var msj = fnValidateDateGreaterThanToday(fecRegistro);
                        if (msj.length > 0){
                            arrMessages.push(msj);
                            FlgError = true;
                        }
                    }

                    if (razonSocial.length == 0) {
                        arrMessages.push("Debe ingresar el Cliente o Proveedor relacionado a la operación.");
                        FlgError = true;
                    }

                    if (numMtoTotal == 0) {
                        arrMessages.push("Falta ingresar productos a la orden.");
                        FlgError = true;
                    }
                    
                    if (idTipoProducto == 0) {
                        arrMessages.push("Seleccione la forma de pago.");
                        FlgError = true;
                    }

                    //IMPRIMIR RESULTADO
                    if (FlgError == true) {
                        fnShowMessageValidation(arrMessages);
                        return false;
                    } else {
                        fnHideMessageValidation();

                        //$("#idLink").attr("href", "#idDivFinal");
                        //$("#idLink").click(); //Origina que llame a la función de FancyBOX y que muestre la URL especificada.
                        
                        $("#idDivFinal").css("display", "inline-block");
                        return false;
                    }

                }
                ;
                
                /*Funcion que permite Imprimir*/
                function fnImprimirVoucher() {                    
                    
                    var message = "Se procederá a IMPRIMIR VOUCHER";
                    fnShowDialogConfirm('form\\:btnImprimirVoucher', message);
                    return false;
                }
                
                /*Función que se ejecuta durante el ciclo de vida de la llamada AJAX.
                *Cierra el IFRAME*/
                function fnAjaxListenImprimirVoucher(data) {                    
                    
                    var idDocuImp = document.getElementById("idDocuImpresion");
                    console.log("idDocuImp " + idDocuImp);                    
                    if (idDocuImp > 0) {

                        switch (data.status) {
                            case "success":
                                fnImprimirVoucher();
                                break;
                        }                    
                    }
                }
                
                
                function ocultarSerie(val){
                    console.log("Valor:" + val);
                }

            </script>
        </ui:define>

        <ui:define name="content">

            <div class="container" > 

                <div id="divResultadoValidacion"></div>



                <p:growl id="message" showDetail="true" />

                <div class="page-header" >
                    <h3>${orderController.desTituloPagina}</h3>
                </div>

                <!-- ****************************************************************************** -->
                <!-- PANEL PARA INGRESO DE DATOS DE LA ORDEN -->
                <!-- ****************************************************************************** -->

                <div class="panelIngresoDatosOrden">
                    
                    <div class="form-group subtitulo" >
                        <h:outputLabel value="DOCUMENTOS RELACIONADOS" rendered="#{not empty orderController.lstViSicdocus}"/>
                    </div>
                    
                    <!-- ********************************** -->
                    <!-- LISTA DE DOCUMENTOS REFERENCIADOS -->
                    <!-- *********************************** -->
                    
                    <p:dataTable                                                        
                        id="idTblDocuments" var="item" 
                        rendered="#{not empty orderController.lstViSicdocus}"
                        value="#{orderController.lstViSicdocus}" 
                        style="margin-bottom:20px;padding: 0px">                                                        

                        <p:column headerText="No." width="25" style="padding: 1px;text-align: center">
                            <h:outputText value="#{orderController.lstViSicdocus.indexOf(item) + 1}" />
                        </p:column>                            

                        <p:column headerText="Evento" width="120" style="color: blue;font-size: 12px;text-align: center">
                            <h:outputText value="#{item.desDocu}" />
                        </p:column>

                        <p:column headerText="Fec. Registro" width="90">
                            <h:outputText value="#{item.fecDesde}" />
                        </p:column>

                        <p:column headerText="Cliente/Proveedor">
                            <h:outputText value="#{item.desPersClieprov}" />
                        </p:column>

                        <p:column headerText="Estado" width="80">
                            <h:outputText value="#{item.desEstadocu}" />
                        </p:column>

                        <p:column headerText="Mto. Pagado" width="75" style="text-align: right">
                            <h:outputText value="S/.#{item.numTotalpagado}" />
                        </p:column>

                        <p:column headerText="Total" width="80" style="text-align: right">
                            <h:outputText value="S/.#{item.numMtototal}" />
                        </p:column>

                        <p:column headerText="Modo Pago" width="110" style="text-align: center">
                            <h:outputText value="#{item.desModoPago}" />
                        </p:column>                        
                        
                        <p:column headerText="Responsable" width="100" style="text-align: center">
                            <h:outputText value="#{item.desPersCreador}" />
                        </p:column>                        
                    </p:dataTable>                    
                    
                    <br/>
                    
                    <table id="idTableFormOrder">
                        <tr>
                            <td class="compra_panelGrid_1">
                                <h:outputLabel value="Fecha:*"/></td>
                            <td class="compra_panelGrid_2">
                                <h:inputText id="fecRegistro" size="10" 
                                             value="#{orderController.desFecRegistro}"
                                             autocomplete="off"
                                             styleClass="form-control datepicker"
                                             style="font-size:14px;font-weight:bold; z-index: 50 "/></td>
                        </tr>
                        <tr >
                            <td colspan="5" style="padding: 8px 0px 8px 0px" ><div class="subtitulo"><h:outputLabel value="DATOS CLIENTE/PROVEEDOR"/></div></td>
                        </tr>
                        <tr>
                            <td class="compra_panelGrid_1">
                                <h:outputLabel value="Doc. Identidad:*"/>
                            </td>
                            <td class="compra_panelGrid_2">
                                <div class="input-group mb-2 mb-sm-0">
                                    <div id="idCantDigitosDocIden" class="input-group-addon">0</div>
                                    <h:inputText id="numDocuIden" autocomplete="off"
                                                 readonly="#{!orderController.flgEditPerson}"
                                                 onkeypress="return fnAllowOnlyNumbers(event)"
                                                 onkeyup="fnCountDigitsCodIden(this)"
                                                 value="#{orderController.sic1idenpersId.codIden}" styleClass="form-control"/>
                                </div>
                            </td>
                            <td class="compra_panelGrid_3" >
                                <h:commandLink  id="btnSearchPerson"                                                
                                                disabled="#{!orderController.flgEditPerson}"
                                                styleClass="btn btn-default"                                          
                                                onclick="return fnValidateDocuIden(document.getElementById('form:numDocuIden').value)"> 
                                    <span class="glyphicon glyphicon-new-window"></span>Buscar
                                    <f:ajax execute="numDocuIden" render="razonSocial itDireccion" listener="#{orderController.searchPerson()}" onevent="fnAjaxListenPersonSearch" />
                                </h:commandLink>
                            </td>
                            <td class="compra_panelGrid_1">
                                <h:outputLabel value="Razón Social:"/>
                            </td>
                            <td class="compra_panelGrid_2">
                                <h:inputText id="razonSocial"
                                             readonly="true"
                                             value="#{orderController.sic1pers.desPers}" styleClass="form-control"/>
                            </td>
                        </tr>
                        <tr>
                            <td class="compra_panelGrid_1">
                                <h:outputLabel value="Dirección:"/>
                            </td>
                            <td colspan="4" class="compra_panelGrid_2">
                                <h:inputText id="itDireccion"
                                             readonly="true"
                                             value="#{orderController.sic1pers.desDireccion}" styleClass="form-control"/>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5" style="padding: 8px 0px 8px 0px" ><div class="subtitulo"><h:outputLabel value="INGRESAR PRODUCTOS"/></div></td>
                        </tr>
                        <tr style="display: #{orderController.flgEditProducts?'':'none'}">
                            <td class="compra_panelGrid_1">
                                <h:outputLabel value="Código Producto:"/>
                            </td>
                            <td class="compra_panelGrid_2">
                                <h:inputText id="codigoProducto"  autocomplete="off" styleClass="form-control" value="#{orderController.sic1prod.codProd}" disabled="#{!orderController.flgEditProducts}">
                                    <f:ajax execute="codigoProducto" render="descProducto pnAutocomplete" event="keyup" listener="#{orderController.searchProduct()}"  onevent="fnShowAutocompleteResult" />
                                </h:inputText>
                            </td>
                            <td class="compra_panelGrid_3" >
                                <h:commandLink  id="idCreateProduct" rendered="#{!orderController.flgIsSale}"
                                                onclick="return fnShowPopupCreateProduct()"
                                                disabled="#{!orderController.flgEditProducts}"
                                                styleClass="btn btn-default"> 
                                    <span class="glyphicon glyphicon-new-window"></span>Nuevo
                                </h:commandLink>
                            </td>
                            <td class="compra_panelGrid_1">
                                <h:outputLabel value="Descripción:"/>
                            </td>
                            <td rowspan="3" >  
                                <h:inputTextarea id="descProducto"
                                                 disabled="true"                                                 
                                                 rows="4"
                                                 cols="30"                                                 
                                                 value="#{orderController.sic1prod.desProd}" />
                            </td>
                        </tr>
                        <tr style="display: #{orderController.flgEditProducts?'':'none'}">
                            <td class="compra_panelGrid_1">
                                <h:outputLabel value="Precio:"/>
                            </td>
                            <td class="compra_panelGrid_2">
                                <div class="input-group mb-2 mb-sm-0">
                                    <div class="input-group-addon">S/.</div>
                                    <h:inputText id="costoUnitario" styleClass="form-control"
                                                 disabled="#{!orderController.flgEditProducts}"
                                                 autocomplete="off"
                                                 value="#{orderController.sic3docuprod.numValor }"
                                                 onkeypress="return fnAllowOnlyDecimalNumbers(event)"
                                                 onblur="formatDecimal_2(this)"/>
                                </div>
                            </td>                           
                        </tr>
                        <tr style="display: #{orderController.flgEditProducts?'':'none'}">
                            <td class="compra_panelGrid_1"><h:outputLabel value="Cantidad:"/></td>
                            <td class="compra_panelGrid_2">
                                <div class="input-group mb-2 mb-sm-0">
                                    <div class="input-group-addon">#&nbsp;&nbsp;</div>
                                    <h:inputText id="cantidad" styleClass="form-control"  
                                                 disabled="#{!orderController.flgEditProducts}"
                                                 autocomplete="off"
                                                 onkeypress="return fnAllowOnlyNumbers(event)"
                                                 value="#{orderController.sic3docuprod.numCantidad }" />
                                </div>
                            </td>                      
                        </tr>
                        <tr style="display: #{orderController.flgEditProducts?'':'none'}">                            
                            <td class="compra_panelGrid_1">                                
                                <h:outputLabel value="Descuento:"/>                                
                            </td>
                            <td class="compra_panelGrid_2">                                
                                <div class="input-group mb-2 mb-sm-0">
                                    <div class="input-group-addon">S/.</div>
                                    <h:inputText id="idDescuento" styleClass="form-control"
                                                 style="color: red"
                                                 disabled="#{!orderController.flgEditProducts}"
                                                 autocomplete="off"
                                                 value="#{orderController.sic3docuprod.numMtodscto}"
                                                 onkeypress="return fnAllowOnlyDecimalNumbers(event)"
                                                 onblur="formatDecimal_2(this)"/>
                                </div>                                
                            </td>   
                            <td class="compra_panelGrid_3">
                                <p:commandLink actionListener="#{orderController.addItem()}" 
                                               disabled="#{!orderController.flgEditProducts}"
                                               onstart="return fnValiteAddProduct()"
                                               styleClass="btn btn-default"
                                               update="form:pnDetOrder,codigoProducto,descProducto,costoUnitario,idDescuento,cantidad,form:pnTotals,idMtoTarjeta,numMtoefectivo" >
                                    <span class="glyphicon glyphicon-plus"></span>Agregar
                                </p:commandLink>
                            </td>
                        </tr>                        
                    </table>

                    <br/>
                    
                    <!-- ****************************************************************************** -->
                    <!-- DETALLE DE PRODUCTOS -->
                    <!-- ****************************************************************************** -->

                    <h:panelGrid id="pnDetOrder" columns="1" width="100%" >

                        <h:dataTable value="#{orderController.lstSic3docuprod}"
                                     var="item"
                                     id="idTableDetOrder"
                                     width="100%"
                                     styleClass = "table-bordered"                                         
                                     columnClasses = "table_style_id
                                                     ,table_style_code
                                                     ,table_style_description_medium
                                                     ,table_style_price_small
                                                     ,table_style_price_small_discount
                                                     ,table_style_amount
                                                     ,table_style_price_7x
                                                     ,table_style_action">

                            <h:column headerClass="table_style_id">
                                <f:facet name="header">No.</f:facet>#{item.numIndex}
                            </h:column> 
                            
                            <h:column headerClass="table_style_code">
                                <f:facet name="header">CODIGO</f:facet>#{item.sic1prod.codProd}
                            </h:column>
                            
                            <h:column headerClass="table_style_description_medium">
                                <f:facet name="header">DESCRIPCION</f:facet>#{item.sic1prod.desProd}
                            </h:column>
                            
                            <h:column  headerClass="table_style_price">
                                <div >
                                    <h:outputLabel value="S/." />
                                    <f:facet name="header">PRECIO</f:facet>#{item.numValor}
                                </div>
                            </h:column>
                            
                            <h:column headerClass="table_style_price_small_discount">
                                <div >
                                    <h:outputLabel value="S/." />
                                    <f:facet name="header">DSCTO</f:facet>#{item.numMtodscto}
                                </div>
                            </h:column>
                            
                            <h:column id="idTableAmount" headerClass="table_style_amount">
                                <f:facet  name="header">CANTIDAD</f:facet>#{item.numCantidad}
                                
                                <f:facet name="footer">
                                    <div class="table_style_total_amount">
                                        #{orderController.numSumItemsAmount}
                                    </div>
                                </f:facet> 
                                
                            </h:column>
                            
                            <h:column headerClass="table_style_price_7x">
                                <div >
                                    <h:outputLabel value="S/." />
                                    <f:facet name="header">TOTAL</f:facet>#{item.numValor * item.numCantidad}
                                </div>
                                
                                <f:facet name="footer">
                                    <div class="table_style_total_price">
                                        <h:outputLabel value="S/." />
                                        #{orderController.numSumItemsPrice}
                                    </div>
                                </f:facet>                                
                            </h:column>
                            
                            <h:column headerClass="table_style_action">
                                <f:facet name="header">ACCION</f:facet>
                                <h:panelGroup rendered="#{empty item.id.idDocu}">
                                    <h:commandLink>                                              
                                        <span class="glyphicon glyphicon-trash"></span>
                                        <f:ajax execute="@this" render="@form" listener="#{orderController.deleteAction(item.numIndex)}" />
                                    </h:commandLink>                                
                                    &nbsp;
                                    <h:commandLink >                                              
                                        <span class="glyphicon glyphicon-pencil"></span>
                                        <f:ajax execute="@this" render="@form" listener="#{orderController.editAction(item.numIndex)}" />
                                    </h:commandLink>
                                </h:panelGroup>                                
                            </h:column>
                           
                            
                        </h:dataTable>

                    </h:panelGrid>
                    &nbsp;
                    <table width="500">
                        
                        <tr>
                            <td class="compra_panelGrid_4">
                                <h:outputLabel value="Nota:"/>
                            </td>
                            <td class="compra_panelGrid_2">
                                <h:inputTextarea id="idDescripcion"                                                  
                                                 rows="4"
                                                 cols="40"
                                                 value="#{orderController.sic1docu.desNotas }" />
                            </td>
                        </tr> 
                        
                    </table> 
                    
                    
                    
                </div>


                <!-- ****************************************************************************** -->
                <!-- PANEL DEL RESUMEN DE LA ORDEN -->
                <!-- ****************************************************************************** -->

                <div class="panelResumenOrden">

                    <table width="100%" >
                        <tr>
                            <td colspan="2" style="color: white; padding: 20px 5px 10px; border-bottom: 2px inset #2C3259">
                                <strong><h4> RESUMEN DE LA ORDEN</h4></strong>
                            </td>
                        </tr>   
                        <tr>
                            <td><h:outputLabel value="" /></td>
                        </tr>
                    </table>

                    <h:panelGroup rendered="#{not empty orderController.itemsPayMode}" >
                        <table width="100%" >
                            <tr>
                                <td class="compra_totales_label">
                                    <h:outputLabel value="Forma de Pago:" />
                                </td>
                                <td class="compra_totales_text">
                                    <h:selectOneMenu id="idPayMode" 
                                                     value="#{orderController.sic1docu.idModapago}" 
                                                     styleClass="form-control">
                                        <f:selectItem itemValue="-1" itemLabel="-- Seleccione --" />
                                        <f:selectItems value="#{orderController.itemsPayMode}" var="c" itemValue="#{c.idGeneral}" itemLabel="#{c.desGeneral}"/>
                                        <f:ajax execute="idPayMode" render="form:pnTotals idLabelTipotarjeta idTextTipotarjeta idLabelMtoTarjeta idMtoTarjeta numMtoefectivo idLabelMtoComiTarjeta idMtoComiTarjeta idLabelNumVoucher idTextNumVoucher" event="change" listener="#{orderController.payModeValueChange}" />
                                    </h:selectOneMenu>
                                </td>
                            </tr>
                            
                            <tr>
                                <td class="compra_totales_label">
                                    <h:panelGroup id="idLabelNumVoucher" >
                                        <h:outputLabel value="Número Voucher(s):" rendered="#{orderController.flgMostrarNumVoucher}"/>
                                    </h:panelGroup>
                                </td>
                                <td class="compra_totales_text">
                                    <h:panelGroup id="idTextNumVoucher" >
                                        <h:inputText value="#{orderController.sic1docu.numVoucher}" autocomplete="off" styleClass="form-control" rendered="#{orderController.flgMostrarNumVoucher}"/>
                                    </h:panelGroup>
                                </td>
                            </tr>

                            <tr>
                                <td class="compra_totales_label">
                                    <h:panelGroup id="idLabelTipotarjeta" >
                                        <h:outputLabel value="Tipo Tarjeta:" rendered="#{not empty orderController.itemsTypeCard}" />
                                    </h:panelGroup>
                                </td>
                                <td class="compra_totales_text">
                                    <h:panelGroup id="idTextTipotarjeta" >
                                        <h:selectOneMenu  value="#{orderController.sic1docu.idTipotarjeta}"
                                                          styleClass="form-control"
                                                          rendered="#{not empty orderController.itemsTypeCard}">                                        
                                            <f:selectItems value="#{orderController.itemsTypeCard}" />
                                        </h:selectOneMenu>
                                    </h:panelGroup>
                                </td>

                            </tr>
                            <tr>
                                <td class="compra_totales_label">
                                    <h:panelGroup id="idLabelMtoTarjeta" >
                                        <h:outputLabel value="Mto. Tarjeta:*" rendered="#{not empty orderController.itemsTypeCard}" />
                                    </h:panelGroup>
                                </td>
                                <td class="compra_totales_text">
                                    <h:panelGroup id="idMtoTarjeta"  >
                                        <h:panelGroup rendered="#{not empty orderController.itemsTypeCard}">
                                            <div class="input-group mb-1 mb-sm-0">
                                                <div class="input-group-addon">S/.</div>
                                                <h:inputText
                                                    id="numMtotarjeta" autocomplete="off"                                                    
                                                    styleClass="form-control"
                                                    value="#{orderController.sic1docu.numMtotarjeta}"                                                
                                                    onkeypress="return fnAllowOnlyDecimalNumbers(event)">
                                                <f:ajax execute="@this" event="blur" render="form:pnTotals message numMtoefectivo numMtotarjeta idLabelMtoComiTarjeta idMtoComiTarjeta" listener="#{orderController.recalculateTotals(false)}" />
                                                </h:inputText>
                                            </div>
                                        </h:panelGroup>
                                    </h:panelGroup>
                                </td>
                            </tr>
                            
                            <tr>
                                <td class="compra_totales_label">
                                    <h:panelGroup id="idLabelMtoComiTarjeta" >
                                        <h:outputLabel value="Total Tarjeta (Inc. Comisión):" rendered="#{not empty orderController.itemsTypeCard}" />
                                    </h:panelGroup>
                                </td>
                                <td class="compra_totales_text">
                                    <h:panelGroup id="idMtoComiTarjeta"  >
                                        <h:outputLabel value="S/." rendered="#{not empty orderController.itemsTypeCard}"/>
                                        <h:outputLabel value="#{orderController.numMtoTotalComiTarjeta}" rendered="#{not empty orderController.itemsTypeCard}"/>
                                    </h:panelGroup>
                                </td>                                
                            </tr>
                            
                            
                            <tr style="color: white; border-top: 1px inset #2C3259">
                                <td class="compra_totales_label">
                                    <h:outputLabel value="Mto.Depo/Efectivo:"/>
                                </td>
                                <td class="compra_totales_text">
                                    <div class="input-group mb-1 mb-sm-0">
                                        <div class="input-group-addon">S/.</div>
                                        <h:inputText
                                            id="numMtoefectivo" autocomplete="off"
                                            styleClass="form-control"
                                            value="#{orderController.sic1docu.numMtoefectivo}"
                                            onkeypress="return fnAllowOnlyDecimalNumbers(event)">
                                            <f:ajax execute="@this" event="blur" render="form:pnTotals message numMtoefectivo" listener="#{orderController.recalculateTotals(false)}" />
                                        </h:inputText>
                                    </div>
                                </td>
                            </tr>
                            
                        </table>
                    </h:panelGroup>                    

                    <h:panelGroup id="pnTotals">

                        <table style="width: 100%">
                            
                            <tr>
                                <td class="compra_totales_label">
                                    <h:outputLabel value="Total Descuento:"/>
                                </td>
                                <td class="compra_totales_text">                                    
                                    <h:outputLabel style="color: red" value="S/." />
                                    <h:outputLabel style="color: red" value="#{orderController.sic1docu.numMtodscto}" />
                                </td>
                            </tr>
                            <tr style="height: 10px">
                                <td></td>
                            </tr>
                            <tr style="color: white; border-top: 1px inset #2C3259 ; font-size: 15px">
                                <td class="compra_totales_label">
                                    <h:outputLabel  value="SUB. TOTAL:" />
                                </td>
                                <td class="compra_totales_text">
                                    <h:outputLabel value="S/." />
                                    <h:outputLabel value="#{orderController.sic1docu.numSubtotal}" />
                                </td>
                            </tr>

                            <tr style="color: white; border-top: 1px inset #2C3259; font-size: 15px">
                                <td class="compra_totales_label">
                                    <h:outputLabel  value="IGV(18%):" />
                                </td>
                                <td class="compra_totales_text">
                                    <h:outputLabel value="S/." />
                                    <h:outputLabel value="#{orderController.sic1docu.numIgv}" />
                                </td>
                            </tr>   

                            <tr style="color: white; border-top: 1px inset #2C3259; font-size: 21px ">
                                <td class="compra_totales_label" >
                                    <h:outputLabel  value="TOTAL:" />
                                </td>
                                <td class="compra_totales_text">
                                    <h:outputLabel value="S/." />
                                    <h:outputLabel id="numMtoTotal" value="#{orderController.sic1docu.numMtoTotal}" />
                                </td>
                            </tr>
                            
                            <tr>
                                <td colspan="2" style="text-align: center; color: white">
                                    <h:panelGroup rendered="#{!orderController.flgIsSale}">
                                        <h:selectBooleanCheckbox value="#{orderController.flgPrecioSinIGV}" disabled="#{!orderController.flgEditProducts}">
                                            <f:ajax execute="@this" event="change" render="form:pnTotals message" listener="#{orderController.recalculateTotals(false)}" />
                                        </h:selectBooleanCheckbox>
                                        <h:outputLabel value="PRECIO NO INCLUYE I.G.V." />
                                    </h:panelGroup>
                                </td>
                            </tr>
                            
                            <!--Se muestra el vuelto -->
                            <tr style="color: white; border-top: 1px inset #2C3259; text-align: center">
                                <td colspan="2">
                                    <h:panelGroup rendered="#{orderController.flgIsSale}" >
                                        <div class="calcularVuelto">VUELTO: #{orderController.sic1docu.numMtovuelto}</div>
                                    </h:panelGroup>
                                </td>
                            </tr>
                            
                            <!--Ocultado: funcionalidad reemplazada-->
                            <tr style="display: none; color: white; border-top: 1px inset #2C3259; text-align: center">
                                <td colspan="2">
                                    <h:panelGroup rendered="#{orderController.flgIsSale}" >
                                        <div class="calcularVuelto" onclick="fnCalcularVuelto()">CALCULAR VUELTO</div>
                                        <input type="text" style="display:none" id="numMtovuelto" value="${orderController.sic1docu.numMtovuelto}" />
                                    </h:panelGroup>
                                </td>
                            </tr>

                        </table>
                    </h:panelGroup>
                </div>


                <!-- ****************************************************************************** -->
                <!-- GRABAR -->
                <!-- ****************************************************************************** -->
                <br/>
                <div style="margin: 30px 0px" class="offset-sm-2 col-sm-10">
                    <h:commandButton value="Grabar"                                   
                                   styleClass="btn btn-primary"
                                   onclick="return fnValidateOrderForm()" >
                    </h:commandButton>
                    &nbsp;
                    <h:selectBooleanCheckbox value="#{orderController.flgPorRecoger}" rendered="false"/>
                    <h:outputLabel value="PENDIENTE DE RECOJO:" rendered="false"/>

                </div>

                <!-- ****************************************************************************** -->
                <!-- ELEMENTOS OCULTOS -->
                <!-- ****************************************************************************** -->
                <table class="ocultarObjeto">
                    <tr>
                        <td><label>CodTRolpers:</label></td>
                        <td><h:inputText id="idCodTRolpers" style="display: none" value="#{orderController.codTRolpersExterno}"/></td>
                        <td><h:inputText id="idDocuImpresion" style="display: none" value="#{orderController.idDocuImpresion}" /></td>
                    </tr>                    
                </table>
                <!-- ********************************** -->
                <!-- INGRESO COMPROBANTE DE PAGO -->
                <!-- *********************************** -->

                <!-- IMPORTANTE: TODO EL CSS UTILIZADO ES DEL ARCHIVO DE FANCY BOX -->
                <div id="idDivFinal" class="jconfirm jconfirm-supervan jconfirm-open" style="display: none">
                    <div class="jconfirm-bg" style="transition-duration: 0.4s; transition-timing-function: cubic-bezier(0.36, 0.55, 0.19, 1);">

                    </div>
                    <div class="jconfirm-scrollpane">
                        <div class="jconfirm-row">
                            <div class="jconfirm-cell">
                                <div class="jconfirm-holder" style="padding-top: 40px; padding-bottom: 40px;">
                                    <div class="jc-bs3-container container">
                                        <div class="jc-bs3-row row justify-content-md-center justify-content-sm-center justify-content-xs-center justify-content-lg-center">
                                            <div class="jconfirm-box-container col-md-6 col-md-offset-3 " style="transform: translate(0px, 0px); transition-duration: 0.4s; transition-timing-function: cubic-bezier(0.36, 0.55, 0.19, 1);">

                                                <div class="jconfirm-content" style="background-color: white; border: 8px solid #C0C0C0; padding: 10px; border-radius: 15px"  >

                                                    <div id="idDivValidation" class="messageValidation" ></div>

                                                    <br/>
                                                    <div style="text-align: center">
                                                        <table style="margin: 0 auto;">
                                                        
                                                        <tr>
                                                            <td class="compra_panelGrid_1"><h:outputLabel value="Tipo Comprobante:"/></td>
                                                            <td>
                                                                <h:selectOneMenu id="somTipoDocu" styleClass="form-control"
                                                                                 value="#{orderController.sic1docu.idStipodocu}" >
                                                                    <f:selectItem itemValue="-1" itemLabel="-- Seleccionar --" />
                                                                    <f:selectItems value="#{orderController.itemSTipoDocu}" var="c" itemValue="#{c.idStipodocu}" itemLabel="#{c.desStipodocu}" />
                                                                </h:selectOneMenu>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td class="compra_panelGrid_1"><h:outputLabel value="Serie:"/></td>
                                                            <td class="compra_panelGrid_2">
                                                                <h:inputText id="codSerie" autocomplete="off"
                                                                             disabled="#{not empty orderController.sic1docu.idDocu}"
                                                                             class="form-control"
                                                                             value="${orderController.sic1docu.codSerie}" />
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td class="compra_panelGrid_1"><h:outputLabel value="Número:"/></td>
                                                            <td class="compra_panelGrid_2">
                                                                <h:inputText id="numDocumento" autocomplete="off"
                                                                             disabled="#{not empty orderController.sic1docu.idDocu}"
                                                                             styleClass="form-control" 
                                                                             onkeypress="return fnAllowOnlyNumbers(event)"
                                                                             value="#{orderController.sic1docu.numDocu }"  />
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    <br/>
                                                    <h:commandButton value="Aceptar" styleClass="btn btn-primary" rendered="#{orderController.codSClaseeven=='VI_SICSCLASEEVENVENTA'?true:false}">
                                                        <f:ajax execute="@form" render="@form"
                                                                listener="#{orderController.saveOrder()}"
                                                                onevent="fnAjaxListenImprimirVoucher"/>

                                                    </h:commandButton>
                                                    <h:commandButton value="Aceptar" styleClass="btn btn-primary" rendered="#{orderController.codSClaseeven=='VI_SICSCLASEEVENVENTA'?false:true}">
                                                        <f:ajax execute="@form" render="@form"
                                                                listener="#{orderController.saveOrder()}"/>

                                                    </h:commandButton>
                                                    &nbsp;
                                                    <h:commandButton value="Cerrar"
                                                                   styleClass="btn btn-danger">
                                                    </h:commandButton>                                                
                                                </div>

                                                </div>
                                            </div>

                                        </div>

                                    </div>

                                </div>

                            </div>

                        </div>

                    </div>

                </div>



                <!-- ********************************** -->
                <!-- AUTOCOMPLETE -->
                <!-- *********************************** -->
                <div id="idDivAutocomplete" class="autocomplete" >
                    <h:panelGroup id="pnAutocomplete" layout="block">
                        <table id="tableIdAutocomplete" class="table table-striped table-bordered bootstrap-datatable datatable">
                            <tbody>
                                <ui:repeat var="e" value="#{orderController.lstProducts}" varStatus="status">
                                    <tr>
                                        <td><h:commandLink value="#{e.getCodProd()} --> (#{e.getNumCantstock()})"  >
                                                <f:ajax execute="pnAutocomplete"  render="form:message form:codigoProducto form:descProducto form:costoUnitario form:pnAutocomplete" listener="#{orderController.selectAutocompleteProduct(e)}"  />
                                            </h:commandLink></td>
                                        <td>#{e.getDesProd()}</td>
                                        <td style="color: blue">#{e.getCodProdint()}</td>
                                    </tr>
                                </ui:repeat>
                            </tbody>
                        </table>
                    </h:panelGroup>
                </div>   

                <a id="linkDialog" href="#" class="iframe"  style="display:none"/>
                <a id="idLink" href="#"  style="display:none"/>
                <h:commandLink  id="btnSearchProduct" style="display:none" >                    
                    <f:ajax execute="codigoProducto" render="codigoProducto descProducto costoUnitario" listener="#{orderController.searchProductByCod()}" />
                </h:commandLink>
                <h:commandButton id="btnImprimirVoucher" value="Imprimir Voucher"  style="display: none">
                    <f:ajax render="message" listener="#{orderController.imprimirVoucher()}"/>
                </h:commandButton>
                
            </div>

        </ui:define>
    </ui:composition>
</html>
